<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- è®¾ç½®é¡µé¢æ ‡é¢˜ä¸º "OOCL Offline LLM Chat" -->
    <title>OOCL Offline LLM Chat</title>
    <!-- è®¾ç½®é¡µé¢å›¾æ ‡ä¸º OOCL çš„ logo -->
    <link rel="icon" href="OOCL_logo_slogan.png" type="image/png">
    <!-- å¼•å…¥å¤–éƒ¨ CSS æ–‡ä»¶ Tailwind CSS æ¡†æ¶ï¼Œç”¨äºæ§åˆ¶é¡µé¢çš„æ ·å¼ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* CSS æ ·å¼ */
        body { 
            /* é¡µé¢èƒŒæ™¯è‰²å’Œæ–‡å­—é¢œè‰²è¿‡æ¸¡åŠ¨ç”»ï¼ŒæŒç»­ 0.3 ç§’ */
            transition: background-color 0.3s, color 0.3s;
            position: relative;
            overflow-x: hidden;
        }
        .dark { 
            /* æš—æ¨¡å¼æ ·å¼ï¼šæ·±è‰²èƒŒæ™¯å’Œæµ…è‰²æ–‡å­— */
            background-color: #111827; 
            color: #e2e8f0; 
        }
        .light { 
            /* äº®æ¨¡å¼æ ·å¼ï¼šæµ…è‰²èƒŒæ™¯å’Œæ·±è‰²æ–‡å­— */
            background-color: #f9fafb; 
            color: #1f2937; 
        }
        #chat-container { 
            /* èŠå¤©å®¹å™¨æœ€å¤§é«˜åº¦ä¸ºè§†å£é«˜åº¦å‡å» 220pxï¼Œæ”¯æŒå‚ç›´æ»šåŠ¨ï¼Œå†…è¾¹è· 1rem */
            max-height: calc(100vh - 220px); 
            overflow-y: auto; 
            padding: 1rem; 
        }
        .chat-bubble { 
            /* èŠå¤©æ°”æ³¡æ ·å¼ ï¼šæœ€å¤§å®½åº¦ 95%ï¼Œåº•éƒ¨å¤–è¾¹è· 1remï¼Œåœ†è§’ 0.75remï¼Œz-index ç¡®ä¿æ˜¾ç¤ºåœ¨èƒŒæ™¯ä¹‹ä¸Š*/
            max-width: 95%; 
            margin-bottom: 1rem; 
            padding: 1rem; 
            border-radius: 0.75rem; 
            position: relative;
            z-index: 10;
        }
        .user-bubble { 
            /* ç”¨æˆ·æ¶ˆæ¯æ°”æ³¡æ ·å¼ï¼šè“è‰²èƒŒæ™¯ï¼Œç™½è‰²æ–‡å­—ï¼Œå³å¯¹é½ï¼Œå¸¦é˜´å½±æ•ˆæœ */
            background-color: #3b82f6; 
            color: white; 
            margin-left: auto; 
            box-shadow: 0 2px 10px rgba(59, 130, 246, 0.3);
        }
        .ai-bubble { 
            /* AI æ¶ˆæ¯æ°”æ³¡æ ·å¼ï¼šæµ…ç°è‰²èƒŒæ™¯ï¼Œæ·±è‰²æ–‡å­—ï¼Œå·¦å¯¹é½ï¼Œå¸¦é˜´å½±æ•ˆæœ */
            background-color: #e2e8f0; 
            color: #1f2937; 
            margin-right: auto; 
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .thinking-bubble { 
            /* æ€è€ƒä¸­æ°”æ³¡æ ·å¼ï¼šæ·¡ç°è‰²èƒŒæ™¯ï¼Œæ·±è‰²æ–‡å­—ï¼Œå·¦å¯¹é½ï¼Œæ–œä½“ */
            background-color: #edf2f7; 
            color: #4a5568; 
            margin-right: auto; 
            font-style: italic; 
        }
        .dark .ai-bubble { 
            /* æš—æ¨¡å¼ AI æ¶ˆæ¯æ°”æ³¡æ ·å¼ï¼šæ·±è‰²èƒŒæ™¯ï¼Œæµ…è‰²æ–‡å­— */
            background-color: #1e293b; 
            color: #e2e8f0; 
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        .dark .thinking-bubble { 
            /* æš—æ¨¡å¼æ€è€ƒä¸­æ°”æ³¡æ ·å¼ï¼šæ·±è‰²èƒŒæ™¯ï¼Œæµ…è‰²æ–‡å­— */
            background-color: #1e293b; 
            color: #94a3b8; 
        }
        
        /* èƒŒæ™¯åŠ¨ç”»æ ·å¼ */
        .bg-pattern {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            opacity: 0.1;
            pointer-events: none;
        }

        /* äº®æ¨¡å¼èƒŒæ™¯ï¼ˆå¤šå½©æ¸å˜ï¼‰ */
        #light-bg {
            /* äº®æ¨¡å¼èƒŒæ™¯é€æ˜åº¦ */
            opacity: 0.1;
        }
        #light-bg svg {
            /* SVG èƒŒæ™¯è¦†ç›–æ•´ä¸ªå®¹å™¨ */
            width: 100%;
            height: 100%;
        }
        #light-bg rect {
            /* çŸ©å½¢æ¸å˜é€æ˜åº¦ */
            opacity: 0.8;
        }

        /* æš—æ¨¡å¼èƒŒæ™¯ï¼ˆè¤ç«è™«ï¼‰ */
        .firefly {
            /* è¤ç«è™«æ•ˆæœï¼šå°åœ†ç‚¹ï¼Œå›ºå®šå®šä½ï¼Œå¸¦åŠ¨ç”»ï¼Œä¸å“åº”é¼ æ ‡äº‹ä»¶ */
            position: fixed;
            left: 50%;
            top: 50%;
            width: 0.4vw;
            height: 0.4vw;
            margin: -0.2vw 0 0 9.8vw;
            animation: ease 200s alternate infinite;
            pointer-events: none;
            z-index: 0;
        }
        .firefly::before,
        .firefly::after {
            /* è¤ç«è™«ä¼ªå…ƒç´ çš„åœ†å½¢æ ·å¼ï¼Œå˜æ¢åŸç‚¹åç§» */
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            transform-origin: -10vw;
        }
        .firefly::before {
            /* è¤ç«è™«æš—éƒ¨ï¼šé»‘è‰²èƒŒæ™¯ï¼Œä½é€æ˜åº¦ï¼Œæ¼‚ç§»åŠ¨ç”» */
            background: black;
            opacity: 0.4;
            animation: drift ease alternate infinite;
        }
        .firefly::after {
            /* è¤ç«è™«äº®éƒ¨ï¼šç™½è‰²èƒŒæ™¯ï¼Œåˆå§‹é€æ˜ï¼Œå¸¦å‘å…‰åŠ¨ç”»å’Œæ¼‚ç§»åŠ¨ç”» */
            background: white;
            opacity: 0;
            box-shadow: 0 0 0vw 0vw yellow;
            animation: drift ease alternate infinite, flash ease infinite;
        }

        /* è¤ç«è™«åŠ¨ç”» */
        @keyframes drift {
            /* æ¼‚ç§»åŠ¨ç”»ï¼š360 åº¦æ—‹è½¬ */
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes flash {
            /* é—ªçƒåŠ¨ç”»ï¼šçŸ­æš‚æ˜¾ç¤ºé»„è‰²å…‰æ™• */
            0%, 30%, 100% {
                opacity: 0;
                box-shadow: 0 0 0vw 0vw yellow;
            }
            5% {
                opacity: 1;
                box-shadow: 0 0 2vw 0.4vw yellow;
            }
        }
        
        /* è¾“å…¥æ¡†æ ·å¼ */
        .dark #question-input,
        .dark #chat-question-input {
            /* æš—æ¨¡å¼è¾“å…¥æ¡†ï¼šæ·±è‰²èƒŒæ™¯ï¼Œæµ…è‰²æ–‡å­—ï¼Œç°è‰²è¾¹æ¡† */
            background-color: #1e293b !important;
            color: #e2e8f0 !important;
            border: 1px solid #334155;
        }
        .light #question-input,
        .light #chat-question-input {
            /* äº®æ¨¡å¼è¾“å…¥æ¡†ï¼šç™½è‰²èƒŒæ™¯ï¼Œæ·±è‰²æ–‡å­—ï¼Œæµ…ç°è¾¹æ¡† */
            background-color: #fff !important;
            color: #1f2937 !important;
            border: 1px solid #d1d5db;
        }
        #question-input:focus, #chat-question-input:focus {
            /* è¾“å…¥æ¡†èšç„¦æ—¶çš„è“è‰²è½®å»“å’Œé˜´å½± */
            outline: 2px solid #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }
        /* æ–‡ä»¶ä¸Šä¼ æŒ‰é’®æ ·å¼ */
        .dark label[for="file-input"],
        .dark label[for="chat-file-input"] {
            /* æš—æ¨¡å¼æ–‡ä»¶ä¸Šä¼ æŒ‰é’®ï¼šæ·±è‰²èƒŒæ™¯ï¼Œæµ…è‰²æ–‡å­—ï¼Œç°è‰²è¾¹æ¡† */
            background-color: #1e293b !important;
            color: #e2e8f0 !important;
            border: 1px solid #334155;
        }
        .dark label[for="file-input"]:hover,
        .dark label[for="chat-file-input"]:hover {
            /* æš—æ¨¡å¼ä¸‹é¼ æ ‡æ‚¬åœæ—¶çš„èƒŒæ™¯è‰² */
            background-color: #334155 !important;
        }
        .light label[for="file-input"],
        .light label[for="chat-file-input"] {
            /* äº®æ¨¡å¼æ–‡ä»¶ä¸Šä¼ æŒ‰é’®ï¼šç™½è‰²èƒŒæ™¯ï¼Œæ·±è‰²æ–‡å­—ï¼Œæµ…ç°è¾¹æ¡† */
            background-color: #fff !important;
            color: #1f2937 !important;
            border: 1px solid #d1d5db;
        }
        .light label[for="file-input"]:hover,
        .light label[for="chat-file-input"]:hover {
            /* äº®æ¨¡å¼ä¸‹é¼ æ ‡æ‚¬åœæ—¶çš„èƒŒæ™¯è‰² */
            background-color: #f3f4f6 !important;
        }

        /* æ¬¢è¿ç•Œé¢ */
        .welcome-container {
            /* æ¬¢è¿ç•Œé¢ï¼šç›¸å¯¹å®šä½ï¼Œz-index ç¡®ä¿æ˜¾ç¤ºåœ¨èƒŒæ™¯ä¹‹ä¸Šï¼Œé€æ˜åº¦è¿‡æ¸¡åŠ¨ç”» */
            position: relative;
            z-index: 10;
            opacity: 1;
            transition: opacity 0.3s ease;
        }
        .hidden {
            /* éšè—å…ƒç´ çš„é€šç”¨ç±» */
            display: none;
        }
        .fade-out {
            /* æ·¡å‡ºæ•ˆæœ */
            opacity: 0;
        }

        /* æ–‡ä»¶ä¸Šä¼ åŒºåŸŸæ ·å¼ */
        .folder-upload-area {
            /* æ–‡ä»¶å¤¹ä¸Šä¼ åŒºåŸŸï¼šè“è‰²è™šçº¿è¾¹æ¡†ï¼Œåœ†è§’ï¼Œå±…ä¸­æ–‡æœ¬ï¼Œå¯ç‚¹å‡»ï¼Œå¸¦è¿‡æ¸¡åŠ¨ç”» */
            border: 2px dashed #3b82f6;
            border-radius: 0.5rem;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin: 1rem 0;
        }
        /* æ‹–æ‹½æ¿€æ´»æ—¶ï¼šç»¿è‰²è¾¹æ¡†ï¼Œæµ…ç»¿è‰²èƒŒæ™¯ */
        .folder-upload-area.drag-active {
            border-color: #10b981;
            background-color: rgba(16, 185, 129, 0.1);
        }
        /* é¼ æ ‡æ‚¬åœæ—¶ï¼šæ·±è“è‰²è¾¹æ¡†ï¼Œæµ…è“è‰²èƒŒæ™¯ */
        .folder-upload-area:hover {
            border-color: #2563eb;
            background-color: rgba(59, 130, 246, 0.1);
        }
        /* RAG æ¨¡å‹åˆ—è¡¨é¡¹æ ·å¼ */
        .rag-model-item {
            /* æ¨¡å‹åˆ—è¡¨é¡¹ï¼š0.2 ç§’è¿‡æ¸¡åŠ¨ç”» */
            transition: all 0.2s;
        }
        
        .rag-model-item:hover {
            /* é¼ æ ‡æ‚¬åœæ—¶ï¼šå‘ä¸Šç§»åŠ¨ 2px */
            transform: translateY(-2px);
        }
        
        .rag-model-item.active {
            /* é€‰ä¸­çŠ¶æ€ï¼šè“è‰²è¾¹æ¡†ï¼Œæµ…è“è‰²èƒŒæ™¯ */
            border-color: #3b82f6;
            background-color: rgba(59, 130, 246, 0.1);
        }
        
        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            /* æ¨¡æ€æ¡†é®ç½©ï¼šå…¨å±è¦†ç›–ï¼ŒåŠé€æ˜é»‘è‰²èƒŒæ™¯ï¼Œå±…ä¸­æ˜¾ç¤ºï¼Œåˆå§‹éšè—ï¼Œé€æ˜åº¦è¿‡æ¸¡ */
        }
        
        .modal-overlay.active {
            /* æ¿€æ´»æ¨¡æ€æ¡†ï¼šæ˜¾ç¤ºå¹¶å¯ç”¨é¼ æ ‡äº‹ä»¶ */
            opacity: 1;
            pointer-events: auto;
        }
        
        .modal-container {
            /* æ¨¡æ€æ¡†å†…å®¹ï¼šç™½è‰²èƒŒæ™¯ï¼Œåœ†è§’ï¼Œæœ€å¤§å®½åº¦ 500pxï¼Œå‚ç›´æ»šåŠ¨ï¼Œåˆå§‹å‘ä¸Šåç§» */
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(-20px);
            transition: transform 0.3s;
        }
        
        .dark .modal-container {
            /* æš—æ¨¡å¼æ¨¡æ€æ¡†ï¼šæ·±è‰²èƒŒæ™¯ï¼Œæµ…è‰²æ–‡å­— */
            background-color: #1e293b;
            color: #e2e8f0;
        }
        
        .modal-overlay.active .modal-container {
            /* æ¨¡æ€æ¡†æ¿€æ´»æ—¶ï¼šæ¢å¤æ­£å¸¸ä½ç½® */
            transform: translateY(0);
        }
    </style>
</head>
<!-- é¡µé¢ä¸»ä½“ï¼Œé»˜è®¤å¯ç”¨æš—æ¨¡å¼ -->
<body class="dark min-h-screen">
    <!-- èƒŒæ™¯å›¾æ¡ˆ -->
    <div id="dark-bg" class="bg-pattern">
        <!-- æš—æ¨¡å¼èƒŒæ™¯å®¹å™¨ï¼Œè¤ç«è™«æ•ˆæœå°†é€šè¿‡ JavaScript åŠ¨æ€æ·»åŠ  -->
    </div>
    <!-- äº®æ¨¡å¼èƒŒæ™¯å®¹å™¨ï¼Œåˆå§‹éšè— -->
    <div id="light-bg" class="bg-pattern hidden">
        <!-- SVG èƒŒæ™¯ï¼Œå®šä¹‰å¤šå½©æ¸å˜æ•ˆæœ -->
        <svg viewBox="0 0 100 100" preserveAspectRatio="xMidYMid slice">
            <defs>
                <!-- å®šä¹‰å¤šä¸ªå¾„å‘æ¸å˜ -->
                <radialGradient id="Gradient1" cx="50%" cy="50%" fx="0.441602%" fy="50%" r=".5">
                    <animate attributeName="fx" dur="34s" values="0%;3%;0%" repeatCount="indefinite"></animate>
                    <stop offset="0%" stop-color="rgba(255, 0, 255, 1)"></stop>
                    <stop offset="100%" stop-color="rgba(255, 0, 255, 0)"></stop>
                </radialGradient>
                <!-- å®šä¹‰å…¶ä»–æ¸å˜ Gradient2 åˆ° Gradient6ï¼Œé¢œè‰²åˆ†åˆ«ä¸ºé»„ã€é’ã€ç»¿ã€è“ã€çº¢ -->
                <radialGradient id="Gradient2" cx="50%" cy="50%" fx="2.68147%" fy="50%" r=".5">
                    <animate attributeName="fx" dur="23.5s" values="0%;3%;0%" repeatCount="indefinite"></animate>
                    <stop offset="0%" stop-color="rgba(255, 255, 0, 1)"></stop>
                    <stop offset="100%" stop-color="rgba(255, 255, 0, 0)"></stop>
                </radialGradient>
                <!-- çŸ©å½¢å¡«å……æ¸å˜ï¼Œå¹¶å¸¦æœ‰æ—‹è½¬ã€ä½ç§»åŠ¨ç”» -->
                <radialGradient id="Gradient3" cx="50%" cy="50%" fx="0.836536%" fy="50%" r=".5">
                    <animate attributeName="fx" dur="21.5s" values="0%;3%;0%" repeatCount="indefinite"></animate>
                    <stop offset="0%" stop-color="rgba(0, 255, 255, 1)"></stop>
                    <stop offset="100%" stop-color="rgba(0, 255, 255, 0)"></stop>
                </radialGradient>
                <radialGradient id="Gradient4" cx="50%" cy="50%" fx="4.56417%" fy="50%" r=".5">
                    <animate attributeName="fx" dur="23s" values="0%;5%;0%" repeatCount="indefinite"></animate>
                    <stop offset="0%" stop-color="rgba(0, 255, 0, 1)"></stop>
                    <stop offset="100%" stop-color="rgba(0, 255, 0, 0)"></stop>
                </radialGradient>
                <radialGradient id="Gradient5" cx="50%" cy="50%" fx="2.65405%" fy="50%" r=".5">
                    <animate attributeName="fx" dur="24.5s" values="0%;5%;0%" repeatCount="indefinite"></animate>
                    <stop offset="0%" stop-color="rgba(0,0,255, 1)"></stop>
                    <stop offset="100%" stop-color="rgba(0,0,255, 0)"></stop>
                </radialGradient>
                <radialGradient id="Gradient6" cx="50%" cy="50%" fx="0.981338%" fy="50%" r=".5">
                    <animate attributeName="fx" dur="25.5s" values="0%;5%;0%" repeatCount="indefinite"></animate>
                    <stop offset="0%" stop-color="rgba(255,0,0, 1)"></stop>
                    <stop offset="100%" stop-color="rgba(255,0,0, 0)"></stop>
                </radialGradient>
            </defs>
            <rect x="13.744%" y="1.18473%" width="100%" height="100%" fill="url(#Gradient1)" transform="rotate(334.41 50 50)">
                <animate attributeName="x" dur="20s" values="25%;0%;25%" repeatCount="indefinite"></animate>
                <animate attributeName="y" dur="21s" values="0%;25%;0%" repeatCount="indefinite"></animate>
                <animateTransform attributeName="transform" type="rotate" from="0 50 50" to="360 50 50" dur="7s" repeatCount="indefinite"></animateTransform>
            </rect>
            <rect x="-2.17916%" y="35.4267%" width="100%" height="100%" fill="url(#Gradient2)" transform="rotate(255.072 50 50)">
                <animate attributeName="x" dur="23s" values="-25%;0%;-25%" repeatCount="indefinite"></animate>
                <animate attributeName="y" dur="24s" values="0%;50%;0%" repeatCount="indefinite"></animate>
                <animateTransform attributeName="transform" type="rotate" from="0 50 50" to="360 50 50" dur="12s" repeatCount="indefinite"></animateTransform>
            </rect>
            <rect x="9.00483%" y="14.5733%" width="100%" height="100%" fill="url(#Gradient3)" transform="rotate(139.903 50 50)">
                <animate attributeName="x" dur="25s" values="0%;25%;0%" repeatCount="indefinite"></animate>
                <animate attributeName="y" dur="12s" values="0%;25%;0%" repeatCount="indefinite"></animate>
                <animateTransform attributeName="transform" type="rotate" from="360 50 50" to="0 50 50" dur="9s" repeatCount="indefinite"></animateTransform>
            </rect>
        </svg>
    </div>
    
    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
     <!-- ä¸»å®¹å™¨ï¼šç›¸å¯¹å®šä½ï¼Œæœ€å¤§å®½åº¦ 4xlï¼Œå±…ä¸­ï¼Œå†…è¾¹è· 4ï¼Œå‚ç›´å¸ƒå±€ -->
    <div class="relative z-10 max-w-4xl mx-auto p-4 h-screen flex flex-col">
        <!-- å¤´éƒ¨ï¼šå·¦å³å¸ƒå±€ï¼Œå¸¦æ¨¡ç³ŠèƒŒæ™¯å’Œé˜´å½± -->
        <header class="flex justify-between items-center mb-4 p-4 rounded-lg backdrop-blur-sm bg-white/30 dark:bg-gray-800/30 shadow-sm">
            <!-- Logo å’Œæ ‡é¢˜åŒºåŸŸ -->
            <div class="flex items-center space-x-3">
                <!-- Logo å›¾ç‰‡ï¼Œé«˜åº¦ 10ï¼Œå®½åº¦è‡ªé€‚åº” -->
                <img src="OOCL_logo_slogan.png" alt="OOCL Logo" class="h-10 w-auto">
                <!-- æ ‡é¢˜ï¼šOOCL AI Assistantï¼Œå­—ä½“åŠ ç²—ï¼Œæ ¹æ®ä¸»é¢˜åˆ‡æ¢é¢œè‰² -->
                <h1 class="text-xl font-bold dark:text-white text-gray-800">OOCL AI Assistant</h1>
            </div>
            <!-- åŠŸèƒ½æŒ‰é’®åŒºåŸŸ -->
            <div class="flex items-center space-x-2">
                <!-- ä¸Šä¸‹æ–‡ç®¡ç†æŒ‰é’® -->
                <button id="context-manager-btn" class="px-3 py-2 rounded-full bg-gradient-to-r from-blue-500 to-purple-500 text-white shadow-sm hover:from-blue-600 hover:to-purple-600 text-xs font-medium transition-all duration-200" title="Context Manager">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                    </svg>
                    Context Manager
                </button>
                <!-- æ¸…é™¤èŠå¤©æŒ‰é’®ï¼šçº¢è‰²å›¾æ ‡ï¼Œæ‚¬åœæ—¶å˜è‰² -->
                <button id="clear-chat" class="p-2 rounded-full bg-white/80 dark:bg-gray-700/80 shadow-sm hover:bg-red-100 dark:hover:bg-red-900 text-red-600 dark:text-red-300 transition-colors" title="Clear Chat">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
                <!-- ä¸»é¢˜åˆ‡æ¢æŒ‰é’®ï¼šæ˜¾ç¤ºå¤ªé˜³æˆ–æœˆäº®å›¾æ ‡ -->
                <button id="theme-toggle" class="p-2 rounded-full bg-white/80 dark:bg-gray-700/80 shadow-sm">
                    <svg id="dark-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 dark:text-yellow-300 text-gray-700" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z" />
                    </svg>
                    <svg id="light-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden text-blue-600" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd" />
                </svg>
                </button>
                <!-- RAG æ¨¡å¼åˆ‡æ¢æŒ‰é’® -->
                <button id="rag-toggle" class="p-2 rounded-full bg-white/80 dark:bg-gray-700/80 shadow-sm ml-2">
                    <span class="text-sm font-medium">RAG</span>
                    <!-- RAG çŠ¶æ€æŒ‡ç¤ºå™¨ï¼šç°è‰²è¡¨ç¤ºå…³é—­ï¼Œç»¿è‰²è¡¨ç¤ºå¼€å¯ -->
                    <span id="rag-status" class="ml-1 inline-block w-3 h-3 rounded-full bg-gray-400"></span>
                </button>
                <!-- ç®¡ç† RAG æ¨¡å‹æŒ‰é’® -->
                <button id="rag-models-btn" class="p-2 rounded-full bg-white/80 dark:bg-gray-700/80 shadow-sm ml-2" title="Manage RAG Models">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                </button>
            </div>
        </header>

        <!-- æ¬¢è¿ç•Œé¢ -->
         <!-- æ¬¢è¿ç•Œé¢ï¼šå‚ç›´å±…ä¸­ï¼ŒåŒ…å« Logoã€æ ‡é¢˜å’Œè¾“å…¥åŒºåŸŸ -->
        <div id="welcome-screen" class="welcome-container flex-1 flex flex-col items-center justify-center p-4 text-center">
            <div class="mb-8">
                <img src="OOCL_logo_slogan.png" alt="OOCL Logo" class="h-32 w-auto mx-auto mb-6">
                <h2 class="text-3xl font-bold dark:text-white text-gray-800 mb-3">Welcome to OOCL AI</h2>
                <p class="dark:text-gray-300 text-gray-600 max-w-lg">Ask questions or upload documents to get insights from our AI assistant.</p>
            </div>
            <!-- è®­ç»ƒè¿›åº¦æ˜¾ç¤º -->
            <div id="welcome-training-progress" class="hidden w-full max-w-lg mt-4">
                <h3 class="text-lg font-medium dark:text-white text-gray-800 mb-2">Training RAG Model</h3>
                <div class="w-full bg-gray-200 dark:bg-gray-700 h-2 rounded-full overflow-hidden">
                    <div id="welcome-training-progress-bar" class="bg-blue-500 h-2 rounded-full" style="width: 0%"></div>
                </div>
                <p id="welcome-training-status" class="text-center mt-2 text-sm">Preparing files...</p>
            </div>
            <!-- è¾“å…¥åŒºåŸŸï¼šæœ€å¤§å®½åº¦ lg -->
            <div class="w-full max-w-lg">
                <div class="relative mb-4">
                    <textarea id="question-input" rows="3" class="w-full p-4 rounded-xl shadow-sm transition-all duration-200 focus:ring-2 focus:ring-blue-500" placeholder="Type your question here..."></textarea>
                    <button id="send-button" class="absolute right-3 bottom-3 p-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 1.414L10.586 9H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
                <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
                <div class="flex items-center justify-center">
                    <input type="file" id="file-input" accept=".docx,.pdf,.xlsx,.txt" multiple class="hidden">
                    <label for="file-input" id="file-input-label" class="flex items-center px-4 py-2 rounded-lg dark:bg-gray-700/80 bg-white/80 shadow-sm hover:bg-gray-100 dark:hover:bg-gray-600/80 transition-colors cursor-pointer mr-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                        </svg>
                        <span>Upload Files</span>
                    </label>
                    <div id="file-info" class="text-sm dark:text-gray-400 text-gray-500"></div>
                </div>
            </div>
        </div>

        <!-- èŠå¤©ç•Œé¢ -->
        <div id="chat-interface" class="hidden flex-1 flex flex-col">
            <div id="chat-container" class="flex-1 overflow-y-auto p-4"></div>
            <!-- è®­ç»ƒè¿›åº¦æ˜¾ç¤º -->
            <div id="chat-training-progress" class="hidden w-full max-w-lg mt-4">
                <h3 class="text-lg font-medium dark:text-white text-gray-800 mb-2">Training RAG Model</h3>
                <div class="w-full bg-gray-200 dark:bg-gray-700 h-2 rounded-full overflow-hidden">
                    <div id="chat-training-progress-bar" class="bg-blue-500 h-2 rounded-full" style="width: 0%"></div>
                </div>
                <p id="chat-training-status" class="text-center mt-2 text-sm">Preparing files...</p>
            </div>
            <div class="p-4 rounded-lg backdrop-blur-sm bg-white/30 dark:bg-gray-800/30 shadow-sm mt-auto">
                <div class="relative">
                    <textarea id="chat-question-input" rows="3" class="w-full p-4 rounded-xl shadow-sm transition-all duration-200 focus:ring-2 focus:ring-blue-500" placeholder="Type your question here..."></textarea>
                    <div class="flex items-center justify-between mt-2">
                        <div class="flex items-center">
                            <input type="file" id="chat-file-input" accept=".docx,.pdf,.xlsx,.txt" multiple class="hidden">
                            <label for="chat-file-input" id="chat-file-input-label" class="flex items-center px-3 py-2 rounded-lg dark:bg-gray-700/80 bg-white/80 shadow-sm hover:bg-gray-100 dark:hover:bg-gray-600/80 transition-colors cursor-pointer text-sm mr-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                                </svg>
                                Attach Files
                            </label>
                            <div id="chat-file-info" class="text-xs dark:text-gray-400 text-gray-500"></div>
                        </div>
                        <button id="chat-send-button" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors shadow-md flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 1.414L10.586 9H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z" clip-rule="evenodd" />
                            </svg>
                            Send
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- RAG æ¨¡å‹æ¨¡æ€æ¡† -->
    <div id="rag-models-modal" class="modal-overlay">
        <div class="modal-container">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold dark:text-white text-gray-800">RAG Models</h3>
                <button id="close-rag-modal" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="mb-4">
                <p class="text-sm dark:text-gray-300 text-gray-600 mb-2">Select a RAG model to use for answering questions:</p>
                <div id="rag-models-list" class="space-y-2 max-h-60 overflow-y-auto">
                    <div class="p-3 text-center text-sm dark:text-gray-400 text-gray-500">
                        Loading models...
                    </div>
                </div>
            </div>
            <!-- è®­ç»ƒè¿›åº¦æ˜¾ç¤º -->
            <div id="modal-training-progress" class="hidden mb-4">
                <h3 class="text-lg font-medium dark:text-white text-gray-800 mb-2">Training RAG Model</h3>
                <div class="w-full bg-gray-200 dark:bg-gray-700 h-2 rounded-full overflow-hidden">
                    <div id="modal-training-progress-bar" class="bg-blue-500 h-2 rounded-full" style="width: 0%"></div>
                </div>
                <p id="modal-training-status" class="text-center mt-2 text-sm">Preparing files...</p>
            </div>
            <!-- æ–°æ¨¡å‹è®­ç»ƒåŒºåŸŸ -->
            <div class="mt-6 border-t dark:border-gray-700 border-gray-200 pt-4">
                <h4 class="font-medium mb-2">Train new model</h4>
                <div class="mb-3">
                    <!-- æ–‡ä»¶å¤¹ä¸Šä¼ åŒºåŸŸ -->
                    <div id="modal-folder-upload" class="border-2 border-dashed border-blue-500 rounded-lg p-4 text-center cursor-pointer hover:bg-blue-50 dark:hover:bg-blue-900/20">
                        <input type="file" id="modal-folder-input" webkitdirectory directory multiple class="hidden">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mx-auto text-blue-500 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11v6m-3-3h6" />
                        </svg>
                        <p class="text-sm">Upload folder with documents</p>
                        <p class="text-xs text-gray-500 mt-1">Model will be named after the folder</p>
                    </div>
                    <div id="modal-folder-info" class="text-xs dark:text-gray-400 text-gray-500 mt-1"></div>
                </div>
                <button id="train-rag-btn" class="w-full py-2 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    Train Model
                </button>
            </div>
            
            <!-- é‡å‘½åæˆåŠŸåçš„æ“ä½œåŒºåŸŸ -->
            <div id="rename-success-area" class="mt-4 p-3 bg-green-50 dark:bg-green-900/20 rounded-lg hidden">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-green-800 dark:text-green-200">Model trained successfully!</p>
                        <p class="text-xs text-green-600 dark:text-green-300" id="trained-model-name">Model: </p>
                    </div>
                    <div class="flex space-x-2">
                        <button id="rename-model-btn" class="px-3 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600">
                            Rename
                        </button>
                        <button id="use-model-btn" class="px-3 py-1 text-xs bg-green-500 text-white rounded hover:bg-green-600">
                            Use Model
                        </button>
                    </div>
                </div>
                
                <!-- é‡å‘½åè¾“å…¥æ¡† -->
                <div id="rename-input-area" class="mt-3 hidden">
                    <div class="flex space-x-2">
                        <input type="text" id="rename-input" class="flex-1 px-2 py-1 text-sm border rounded dark:border-gray-600 dark:bg-gray-700" placeholder="Enter new name">
                        <button id="confirm-rename-btn" class="px-3 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600">
                            Confirm
                        </button>
                        <button id="cancel-rename-btn" class="px-3 py-1 text-xs bg-gray-500 text-white rounded hover:bg-gray-600">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
// DOM elements
    const chatContainer = document.getElementById('chat-container');
    const welcomeScreen = document.getElementById('welcome-screen');
    const chatInterface = document.getElementById('chat-interface');
    const questionInput = document.getElementById('question-input');
    const chatQuestionInput = document.getElementById('chat-question-input');
    const fileInput = document.getElementById('file-input');
    const chatFileInput = document.getElementById('chat-file-input');
    const sendButton = document.getElementById('send-button');
    const chatSendButton = document.getElementById('chat-send-button');
    const themeToggle = document.getElementById('theme-toggle');
    const darkIcon = document.getElementById('dark-icon');
    const lightIcon = document.getElementById('light-icon');
    const fileInfo = document.getElementById('file-info');
    const chatFileInfo = document.getElementById('chat-file-info');
    const darkBg = document.getElementById('dark-bg');
    const lightBg = document.getElementById('light-bg');
    const ragToggle = document.getElementById('rag-toggle');
    const ragStatus = document.getElementById('rag-status');
    const fileInputLabel = document.getElementById('file-input-label');
    const chatFileInputLabel = document.getElementById('chat-file-input-label');
    const clearChatButton = document.getElementById('clear-chat');
    const contextManagerBtn = document.getElementById('context-manager-btn');
    const folderUploadArea = document.getElementById('folder-upload-area');
    const folderInput = document.getElementById('folder-input');
    const folderInfo = document.getElementById('folder-info');
    const ragModelsBtn = document.getElementById('rag-models-btn');
    const ragModelsModal = document.getElementById('rag-models-modal');
    const closeRagModalBtn = document.getElementById('close-rag-modal');
    const ragModelsList = document.getElementById('rag-models-list');
    const modalFolderUpload = document.getElementById('modal-folder-upload');
    const modalFolderInput = document.getElementById('modal-folder-input');
    const modalFolderInfo = document.getElementById('modal-folder-info');
    const trainRagBtn = document.getElementById('train-rag-btn');
    const trainingProgressContainer = document.getElementById('training-progress-container');
    const trainingProgress = document.getElementById('training-progress');
    const trainingStatus = document.getElementById('training-status');
    const welcomeTrainingProgress = document.getElementById('welcome-training-progress');
    const welcomeTrainingProgressBar = document.getElementById('welcome-training-progress-bar');
    const welcomeTrainingStatus = document.getElementById('welcome-training-status');
    const chatTrainingProgress = document.getElementById('chat-training-progress');
    const chatTrainingProgressBar = document.getElementById('chat-training-progress-bar');
    const chatTrainingStatus = document.getElementById('chat-training-status');
    const modalTrainingProgress = document.getElementById('modal-training-progress');
    const modalTrainingProgressBar = document.getElementById('modal-training-progress-bar');
    const modalTrainingStatus = document.getElementById('modal-training-status');

    // çŠ¶æ€å˜é‡
    let isDarkMode = true;
    let isRagEnabled = false;
    let currentRagModel = 'None'; 
    let availableRagModels = [];
    let isTraining = false; 
    let isStreamingEnabled = true;
    let messageCount = 0; 
    let currentSessionId = localStorage.getItem('oocl_session_id') || null;
    let lastTrainedModelName = ''; // å­˜å‚¨æœ€åè®­ç»ƒçš„æ¨¡å‹åç§°

    // ç”Ÿæˆæˆ–è·å–session ID
    function getOrCreateSessionId() {
        if (!currentSessionId) {
            currentSessionId = 'oocl_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('oocl_session_id', currentSessionId);
        }
        return currentSessionId;
    }

    // æ›´æ–°ä¸Šä¸‹æ–‡æŒ‰é’®æ˜¾ç¤º
    function updateContextButton() {
        if (contextManagerBtn) {
            const messageCountText = Math.floor(messageCount / 2);
            contextManagerBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                </svg>
                Context (${messageCountText})
            `;
        }
    }

    // åç«¯ API åŸºç¡€ URL
    const BASE_URL = 'http://localhost:5000';

    // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
    function initializeEventListeners() {
        // å‘é€æŒ‰é’®äº‹ä»¶
        sendButton?.addEventListener('click', () => sendMessage(questionInput, fileInput));
        chatSendButton?.addEventListener('click', () => sendMessage(chatQuestionInput, chatFileInput));

        // è¾“å…¥æ¡†å›è½¦é”®äº‹ä»¶
        questionInput?.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage(questionInput, fileInput);
            }
        });
        chatQuestionInput?.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage(chatQuestionInput, chatFileInput);
            }
        });

        // æ–‡ä»¶è¾“å…¥äº‹ä»¶
        fileInput?.addEventListener('change', updateFileInfo);
        chatFileInput?.addEventListener('change', updateChatFileInfo);

        // ä¸»é¢˜åˆ‡æ¢
        themeToggle?.addEventListener('click', toggleTheme);

        // æ¸…é™¤èŠå¤©
        clearChatButton?.addEventListener('click', clearChat);

        // RAG æ¨¡å¼åˆ‡æ¢
        ragToggle?.addEventListener('click', toggleRagMode);

        // RAG æ¨¡å‹æ¨¡æ€æ¡†äº‹ä»¶
        ragModelsBtn?.addEventListener('click', openRagModelsModal);
        closeRagModalBtn?.addEventListener('click', closeRagModelsModal);
        modalFolderUpload?.addEventListener('click', () => modalFolderInput?.click());
        modalFolderInput?.addEventListener('change', () => {
            const fileCount = modalFolderInput.files.length;
            let folderName = '';
            
            if (fileCount > 0) {
                // ä»ç¬¬ä¸€ä¸ªæ–‡ä»¶çš„è·¯å¾„ä¸­æå–æ–‡ä»¶å¤¹åç§°
                const firstFile = modalFolderInput.files[0];
                const pathParts = firstFile.webkitRelativePath.split('/');
                folderName = pathParts[0]; // ç¬¬ä¸€éƒ¨åˆ†æ˜¯æ–‡ä»¶å¤¹åç§°
            }
            
            modalFolderInfo.textContent = fileCount > 0 ? `${fileCount} files selected from folder: ${folderName}` : '';
            trainRagBtn.disabled = fileCount === 0 || isTraining;
        });
        
        // ç§»é™¤åŸæ¥çš„æ¨¡å‹åç§°è¾“å…¥äº‹ä»¶ç›‘å¬å™¨
        // newRagName?.addEventListener('input', () => {
        //     trainRagBtn.disabled = !newRagName.value || modalFolderInput.files.length === 0 || isTraining;
        // });
        
        trainRagBtn?.addEventListener('click', startRagTraining);

        // æ·»åŠ é‡å‘½åç›¸å…³çš„äº‹ä»¶ç›‘å¬å™¨
        document.getElementById('rename-model-btn')?.addEventListener('click', showRenameInput);
        document.getElementById('use-model-btn')?.addEventListener('click', useTrainedModel);
        document.getElementById('confirm-rename-btn')?.addEventListener('click', confirmRename);
        document.getElementById('cancel-rename-btn')?.addEventListener('click', cancelRename);

        // æ·»åŠ  SSE ç›‘å¬ä»¥è·å–è®­ç»ƒè¿›åº¦
        const source = new EventSource(`${BASE_URL}/training_progress`);
        source.onmessage = (event) => {
            const data = JSON.parse(event.data);
            if (data.is_training || data.percentage > 0) {
                updateTrainingProgress(data.percentage, data.status, !!data.error);
            } else {
                mainTrainingProgress?.classList.add('hidden');
                chatTrainingProgress?.classList.add('hidden');
                modalTrainingProgress?.classList.add('hidden');
            }
            if (data.error) {
                displayMessage('error', data.error);
                isTraining = false;
                trainRagBtn.disabled = false;
            }
        };
        source.onerror = () => {
            console.error('SSE connection error');
            updateTrainingProgress(100, 'Error: Lost connection to server', true);
            setTimeout(() => {
                mainTrainingProgress?.classList.add('hidden');
                chatTrainingProgress?.classList.add('hidden');
                modalTrainingProgress?.classList.add('hidden');
                mainTrainingProgressBar.classList.remove('bg-red-500');
                chatTrainingProgressBar.classList.remove('bg-red-500');
                modalTrainingProgressBar.classList.remove('bg-red-500');
                mainTrainingProgressBar.style.width = '0%';
                chatTrainingProgressBar.style.width = '0%';
                modalTrainingProgressBar.style.width = '0%';
                isTraining = false;
                trainRagBtn.disabled = false;
            }, 3000);
        };
        
        // æ·»åŠ ä¸Šä¸‹æ–‡ç®¡ç†å™¨æŒ‰é’®çš„äº‹ä»¶ç›‘å¬å™¨
        if (contextManagerBtn) {
            contextManagerBtn.addEventListener('click', manageContext);
            console.log('contextManager event listener added'); // è°ƒè¯•ä¿¡æ¯
        } else {
            console.error('contextManagerBtn element not found!'); // è°ƒè¯•ä¿¡æ¯
        }
    }
    
    // æ˜¾ç¤ºå¯¹è¯ä¸Šä¸‹æ–‡
    async function showContext() {
        console.log('showContext function called'); // è°ƒè¯•ä¿¡æ¯
        try {
            const sessionId = getOrCreateSessionId();
            console.log('Session ID:', sessionId); // è°ƒè¯•ä¿¡æ¯
            
            const response = await fetch(`${BASE_URL}/get-context?session_id=${sessionId}`);
            console.log('Response status:', response.status); // è°ƒè¯•ä¿¡æ¯
            
            const data = await response.json();
            console.log('Response data:', data); // è°ƒè¯•ä¿¡æ¯
            
            if (data.context && data.context.length > 0) {
                let contextDisplay = `Context (${data.context.length} messages):\n\n`;
                data.context.forEach((msg, index) => {
                    contextDisplay += `${index + 1}. ${msg.role}: ${msg.content}\n\n`;
                });
                console.log('Displaying context:', contextDisplay); // è°ƒè¯•ä¿¡æ¯
                displayMessage('system', contextDisplay);
            } else {
                console.log('No context available'); // è°ƒè¯•ä¿¡æ¯
                displayMessage('system', 'No conversation context available.');
            }
        } catch (error) {
            console.error('Error in showContext:', error); // è°ƒè¯•ä¿¡æ¯
            displayMessage('error', `Error fetching context: ${error.message}`);
        }
    }

    // æ¸…é™¤å¯¹è¯ä¸Šä¸‹æ–‡
    async function clearContext() {
        try {
            const sessionId = getOrCreateSessionId();
            console.log('Clearing context for session:', sessionId); // è°ƒè¯•ä¿¡æ¯
            
            const response = await fetch(`${BASE_URL}/clear-context`, { 
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ session_id: sessionId })
            });
            
            console.log('Clear context response status:', response.status); // è°ƒè¯•ä¿¡æ¯
            const data = await response.json();
            console.log('Clear context response data:', data); // è°ƒè¯•ä¿¡æ¯
            
            if (data.status === 'success') {
                messageCount = 0;
                updateContextButton(); // æ›´æ–°æŒ‰é’®æ˜¾ç¤º
                displayMessage('system', 'Conversation context cleared successfully.');
            } else {
                displayMessage('error', 'Failed to clear context.');
            }
        } catch (error) {
            console.error('Error in clearContext:', error); // è°ƒè¯•ä¿¡æ¯
            displayMessage('error', `Error clearing context: ${error.message}`);
        }
    }

    // ä¸Šä¸‹æ–‡ç®¡ç†å™¨ - ç»„åˆåŠŸèƒ½
    async function manageContext() {
        const contextContainer = document.createElement('div');
        contextContainer.className = 'context-manager-popup fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white dark:bg-gray-800 rounded-lg shadow-xl border border-gray-200 dark:border-gray-700 p-6 z-50 max-w-md w-full mx-4';
        
        contextContainer.innerHTML = `
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold dark:text-white text-gray-800">Context Manager</h3>
                <button id="close-context-manager" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="space-y-3">
                <button id="popup-show-context" class="w-full px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors">
                    ğŸ“‹ Show Current Context
                </button>
                <button id="popup-clear-context" class="w-full px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition-colors">
                    ğŸ—‘ï¸ Clear Context
                </button>
                <div class="text-center text-sm text-gray-500 dark:text-gray-400 pt-2">
                    Current messages: <span class="font-medium">${Math.floor(messageCount / 2)}</span>
                </div>
            </div>
        `;
        
        // Add overlay
        const overlay = document.createElement('div');
        overlay.className = 'context-manager-overlay fixed inset-0 bg-black bg-opacity-50 z-40';
        
        document.body.appendChild(overlay);
        document.body.appendChild(contextContainer);
        
        // Close handlers
        const closeManager = () => {
            document.body.removeChild(contextContainer);
            document.body.removeChild(overlay);
        };
        
        document.getElementById('close-context-manager').onclick = closeManager;
        overlay.onclick = closeManager;
        
        // Button handlers
        document.getElementById('popup-show-context').onclick = async () => {
            await showContext();
            closeManager();
        };
        
        document.getElementById('popup-clear-context').onclick = async () => {
            if (confirm('Are you sure you want to clear the conversation context?')) {
                await clearContext();
                closeManager();
                
                // Update the popup display if reopened
                setTimeout(() => {
                    updateContextButton();
                }, 100);
            }
        };
    }

    // æ˜¾ç¤ºé‡å‘½åæˆåŠŸåŒºåŸŸ
    function showRenameSuccessArea(modelName) {
        lastTrainedModelName = modelName;
        const renameSuccessArea = document.getElementById('rename-success-area');
        const trainedModelNameSpan = document.getElementById('trained-model-name');
        
        if (renameSuccessArea && trainedModelNameSpan) {
            trainedModelNameSpan.textContent = `Model: ${modelName}`;
            renameSuccessArea.classList.remove('hidden');
        }
    }

    // æ˜¾ç¤ºé‡å‘½åè¾“å…¥æ¡†
    function showRenameInput() {
        const renameInputArea = document.getElementById('rename-input-area');
        const renameInput = document.getElementById('rename-input');
        
        if (renameInputArea && renameInput) {
            renameInputArea.classList.remove('hidden');
            renameInput.value = lastTrainedModelName;
            renameInput.focus();
        }
    }

    // ä½¿ç”¨è®­ç»ƒå¥½çš„æ¨¡å‹
    function useTrainedModel() {
        if (lastTrainedModelName) {
            selectRagModel(lastTrainedModelName);
            
            // éšè—é‡å‘½åæˆåŠŸåŒºåŸŸ
            const renameSuccessArea = document.getElementById('rename-success-area');
            if (renameSuccessArea) {
                renameSuccessArea.classList.add('hidden');
            }
            
            // æ‰“å¼€RAGæ¨¡å‹æ¨¡æ€æ¡†ä»¥æ˜¾ç¤ºé€‰ä¸­çš„æ¨¡å‹
            openRagModelsModal();
        }
    }

    // ç¡®è®¤é‡å‘½å
    async function confirmRename() {
        const renameInput = document.getElementById('rename-input');
        const newName = renameInput?.value.trim();
        
        if (!newName) {
            displayMessage('error', 'Please enter a valid name.');
            return;
        }
        
        if (newName === lastTrainedModelName) {
            cancelRename();
            return;
        }
        
        try {
            const response = await fetch(`${BASE_URL}/rename_rag_model`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    old_name: lastTrainedModelName,
                    new_name: newName
                })
            });

            const result = await response.json();
            if (result.error) {
                displayMessage('error', `Rename failed: ${result.error}`);
                return;
            }

            // æ›´æ–°æœ€åè®­ç»ƒçš„æ¨¡å‹åç§°
            lastTrainedModelName = newName;
            
            // æ›´æ–°æ˜¾ç¤º
            const trainedModelNameSpan = document.getElementById('trained-model-name');
            if (trainedModelNameSpan) {
                trainedModelNameSpan.textContent = `Model: ${newName}`;
            }
            
            // éšè—é‡å‘½åè¾“å…¥åŒºåŸŸ
            cancelRename();
            
            // åˆ·æ–°æ¨¡å‹åˆ—è¡¨
            loadRagModels();
            displayMessage('system', `Model renamed to "${newName}" successfully.`);
            
        } catch (error) {
            displayMessage('error', `Rename error: ${error.message}`);
        }
    }

    // å–æ¶ˆé‡å‘½å
    function cancelRename() {
        const renameInputArea = document.getElementById('rename-input-area');
        const renameInput = document.getElementById('rename-input');
        
        if (renameInputArea) {
            renameInputArea.classList.add('hidden');
        }
        
        if (renameInput) {
            renameInput.value = '';
        }
    }

    // å‘é€æ¶ˆæ¯ï¼ˆé—®é¢˜å’Œå¯é€‰æ–‡ä»¶ï¼‰
    async function sendMessage(inputElement, fileInputElement) {
        const question = inputElement.value.trim();
        const files = fileInputElement.files;
        
        // æ£€æŸ¥RAGæ¨¡å¼ä¸‹æ˜¯å¦å°è¯•ä¸Šä¼ æ–‡ä»¶
        if (isRagEnabled && files.length > 0) {
            displayMessage('error', 'File upload is not allowed in RAG mode. Please disable RAG mode to upload files.');
            return;
        }
        
        if (!question && files.length === 0) {
            displayMessage('error', 'Please enter a question or upload files.');
            return;
        }

        if (inputElement === questionInput) {
            showChatInterface();
        }
        // ç¦ç”¨è¾“å…¥æ§ä»¶
        setInputControlsDisabled(true, inputElement === chatQuestionInput);

        // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯å¹¶æ¸…ç©ºè¾“å…¥
        if (question) {
            displayMessage('user', question);
            saveMessage('user', question);
            inputElement.value = ''; // Clear input immediately after sending
            messageCount++;
            updateContextButton(); // æ›´æ–°æŒ‰é’®æ˜¾ç¤º
        }
        if (files.length > 0) {
            displayMessage('system', `Uploading ${files.length} file(s)...`);
        }

        // æ˜¾ç¤ºæ€è€ƒä¸­æ¶ˆæ¯
        const thinkingId = Date.now();
        displayThinkingMessage(thinkingId);

        try {
            const sessionId = getOrCreateSessionId();
            let response;

            if (files.length > 0 && !isRagEnabled) {
                // å‘é€æ–‡ä»¶å’Œé—®é¢˜ - ä½¿ç”¨æµå¼å“åº”
                const formData = new FormData();
                formData.append('question', question);
                formData.append('session_id', sessionId);
                for (let file of files) {
                    formData.append('file', file);
                }
                response = await fetch(`${BASE_URL}/upload_and_ask`, {
                    method: 'POST',
                    body: formData
                });
            } else {
                // ä½¿ç”¨ RAG æˆ–æ™®é€šé—®é¢˜ - ä½¿ç”¨æµå¼å“åº”
                const endpoint = isRagEnabled ? '/rag_ask' : '/ask-stream';
                response = await fetch(`${BASE_URL}${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        question, 
                        model_id: currentRagModel,
                        session_id: sessionId
                    })
                });
            }

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            removeThinkingMessage(thinkingId);

            // åˆ›å»ºAIæ¶ˆæ¯å®¹å™¨
            const messageDiv = createMessageElement('ai', '');
            chatContainer.appendChild(messageDiv);
            scrollToBottom();

            // è¯»å–æµå¼å“åº”
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let fullResponse = '';

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                const chunk = decoder.decode(value, { stream: true });
                const lines = chunk.split('\n');

                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const data = line.slice(6).trim();
                        if (data === '[DONE]' || data === '') {
                            continue;
                        }
                        try {
                            const parsed = JSON.parse(data);
                            if (parsed.content) {
                                fullResponse += parsed.content;
                                const messageContent = messageDiv.querySelector('.message-content');
                                messageContent.textContent = fullResponse;
                                scrollToBottom();
                            } else if (parsed.error) {
                                displayMessage('error', `Error: ${parsed.error}`);
                                return;
                            } else if (parsed.done) {
                                // æµå¼å“åº”ç»“æŸ
                                break;
                            }
                        } catch (e) {
                            // å¿½ç•¥è§£æé”™è¯¯ï¼Œå¯èƒ½æ˜¯ä¸å®Œæ•´çš„JSON
                            console.log('JSON parse error (ignoring):', e.message);
                        }
                    }
                }
            }

            // ä¿å­˜å®Œæ•´å“åº”
            if (fullResponse) {
                saveMessage('ai', fullResponse);
                messageCount++;
                updateContextButton(); // æ›´æ–°æŒ‰é’®æ˜¾ç¤º
            }

            // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
            fileInputElement.value = '';
            if (fileInputElement === fileInput) {
                fileInfo.textContent = '';
            } else {
                chatFileInfo.textContent = '';
            }
        } catch (error) {
            removeThinkingMessage(thinkingId);
            displayMessage('error', `Error: ${error.message}`);
        } finally {
            setInputControlsDisabled(false, inputElement === chatQuestionInput);
        }
    }

    // æ›´æ–°æ–‡ä»¶ä¿¡æ¯æ˜¾ç¤º
    function updateFileInfo() {
        const files = fileInput.files;
        fileInfo.textContent = files.length > 0 ? `${files.length} file(s) selected` : '';
    }

    function updateChatFileInfo() {
        const files = chatFileInput.files;
        chatFileInfo.textContent = files.length > 0 ? `${files.length} file(s) selected` : '';
    }

    // æ¸…é™¤èŠå¤©å†å²
    function clearChat() {
        chatContainer.innerHTML = '';
        localStorage.removeItem('chatHistory');
        displayMessage('system', 'Chat history cleared.');
    }

    // åˆ‡æ¢ä¸»é¢˜
    function toggleTheme() {
        isDarkMode = !isDarkMode;
        document.body.classList.toggle('dark', isDarkMode);
        document.body.classList.toggle('light', !isDarkMode);
        darkIcon?.classList.toggle('hidden', !isDarkMode);
        lightIcon?.classList.toggle('hidden', isDarkMode);
        darkBg?.classList.toggle('hidden', !isDarkMode);
        lightBg?.classList.toggle('hidden', isDarkMode);
        localStorage.setItem('darkMode', isDarkMode);
        if (isDarkMode) {
            darkBg.innerHTML = ''; 
            createFireflies(); 
        }
    }

    // åˆ‡æ¢ RAG æ¨¡å¼
    function toggleRagMode() {
        if(currentRagModel === 'None') {
            displayMessage('system', 'Please select a RAG model first.');
            return;
        }
        isRagEnabled = !isRagEnabled;
        ragStatus.className = `ml-1 inline-block w-3 h-3 rounded-full ${isRagEnabled ? 'bg-green-500' : 'bg-gray-400'}`;
        
        if (isRagEnabled) {
            // ç¦ç”¨æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½
            fileInputLabel?.classList.add('opacity-50', 'pointer-events-none');
            chatFileInputLabel?.classList.add('opacity-50', 'pointer-events-none');
            fileInput.disabled = true;
            chatFileInput.disabled = true;
            fileInput.value = '';
            chatFileInput.value = '';
            fileInfo.textContent = '';
            chatFileInfo.textContent = '';
            displayMessage('system', `RAG mode enabled with model: ${currentRagModel}. File upload is disabled in RAG mode.`);
        } else {
            // å¯ç”¨æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½
            fileInputLabel?.classList.remove('opacity-50', 'pointer-events-none');
            chatFileInputLabel?.classList.remove('opacity-50', 'pointer-events-none');
            fileInput.disabled = false;
            chatFileInput.disabled = false;
            displayMessage('system', 'RAG mode disabled. File upload is now available.');
        }
    }



    // æ‰“å¼€ RAG æ¨¡å‹æ¨¡æ€æ¡†
    function openRagModelsModal() {
        loadRagModels();
        ragModelsModal?.classList.add('active');
    }

    // å…³é—­ RAG æ¨¡å‹æ¨¡æ€æ¡†
    function closeRagModelsModal() {
        ragModelsModal?.classList.remove('active');
    }

    // åŠ è½½ RAG æ¨¡å‹
    async function loadRagModels() {
        try {
            const response = await fetch(`${BASE_URL}/rag_models`);
            const data = await response.json();
            if (data.error) {
                ragModelsList.innerHTML = `<div class="p-3 text-center text-red-500">Error: ${data.error}</div>`;
                return;
            }

            availableRagModels = data.models || [];
            if (availableRagModels.length === 0) {
                ragModelsList.innerHTML = `<div class="p-3 text-center text-sm">No models available. Train a new model below.</div>`;
                return;
            }

            ragModelsList.innerHTML = availableRagModels.map(model => `
                <div class="rag-model-item p-3 border dark:border-gray-700 border-gray-300 rounded-lg flex justify-between items-center ${model === currentRagModel ? 'active' : ''}" data-model="${model}">
                    <div class="flex-1">
                        <div class="font-medium">${model}</div>
                        <div class="text-xs dark:text-gray-400 text-gray-500">${model === 'default' ? 'System default model' : 'Custom model'}</div>
                    </div>
                    <div class="flex space-x-2">
                        <button class="select-model-btn px-3 py-1 text-sm bg-blue-500 text-white rounded hover:bg-blue-600" data-model="${model}" ${model === currentRagModel ? 'disabled' : ''}>
                            ${model === currentRagModel ? 'Selected' : 'Select'}
                        </button>
                        ${model !== 'default' ? `
                            <button class="rename-existing-model-btn px-2 py-1 text-xs bg-gray-500 text-white rounded hover:bg-gray-600" data-model="${model}" title="Rename Model">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                            </button>
                            <button class="delete-model-btn px-2 py-1 text-xs bg-red-500 text-white rounded hover:bg-red-600" data-model="${model}" title="Delete Model">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        ` : ''}
                    </div>
                </div>
            `).join('');

            // ç»‘å®šé€‰æ‹©æŒ‰é’®äº‹ä»¶
            document.querySelectorAll('.select-model-btn').forEach(btn => {
                btn.addEventListener('click', () => selectRagModel(btn.getAttribute('data-model')));
            });

            // ç»‘å®šé‡å‘½åæŒ‰é’®äº‹ä»¶
            document.querySelectorAll('.rename-existing-model-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showRenameDialog(btn.getAttribute('data-model'));
                });
            });

            // ç»‘å®šåˆ é™¤æŒ‰é’®äº‹ä»¶
            document.querySelectorAll('.delete-model-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showDeleteDialog(btn.getAttribute('data-model'));
                });
            });
        } catch (error) {
            console.error('Error loading RAG models:', error);
            ragModelsList.innerHTML = `<div class="p-3 text-center text-red-500">Error loading models. Please try again.</div>`;
        }
    }

    // é€‰æ‹© RAG æ¨¡å‹
    function selectRagModel(modelName) {
        currentRagModel = modelName;
        
        // æ›´æ–°æ¨¡å‹åˆ—è¡¨ä¸­çš„é€‰ä¸­çŠ¶æ€
        document.querySelectorAll('.rag-model-item').forEach(item => {
            item.classList.remove('active');
            const selectBtn = item.querySelector('.select-model-btn');
            if (selectBtn) {
                selectBtn.textContent = 'Select';
                selectBtn.disabled = false;
            }
        });
        
        // è®¾ç½®æ–°é€‰ä¸­çš„æ¨¡å‹
        const selectedItem = document.querySelector(`[data-model="${modelName}"]`);
        if (selectedItem) {
            selectedItem.classList.add('active');
            const selectBtn = selectedItem.querySelector('.select-model-btn');
            if (selectBtn) {
                selectBtn.textContent = 'Selected';
                selectBtn.disabled = true;
            }
        }
        
        // æ˜¾ç¤ºé€‰æ‹©æˆåŠŸæ¶ˆæ¯
        displayMessage('system', `RAG model "${modelName}" selected successfully.`);
        
        // å…³é—­æ¨¡æ€æ¡†
        closeRagModelsModal();
    }

    // æ˜¾ç¤ºé‡å‘½åå¯¹è¯æ¡†
    function showRenameDialog(modelName) {
        const newName = prompt(`Rename model "${modelName}" to:`, modelName);
        if (newName && newName.trim() && newName.trim() !== modelName) {
            renameExistingModel(modelName, newName.trim());
        }
    }

    // æ˜¾ç¤ºåˆ é™¤ç¡®è®¤å¯¹è¯æ¡†
    function showDeleteDialog(modelName) {
        if (confirm(`Are you sure you want to delete the model "${modelName}"? This action cannot be undone.`)) {
            deleteExistingModel(modelName);
        }
    }

    // é‡å‘½åç°æœ‰æ¨¡å‹
    async function renameExistingModel(oldName, newName) {
        try {
            const response = await fetch(`${BASE_URL}/rename_rag_model`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    old_name: oldName,
                    new_name: newName
                })
            });

            const result = await response.json();
            if (result.error) {
                displayMessage('error', `Rename failed: ${result.error}`);
                return;
            }

            // æ›´æ–°å½“å‰é€‰ä¸­çš„æ¨¡å‹åç§°ï¼ˆå¦‚æœè¢«é‡å‘½åçš„æ˜¯å½“å‰é€‰ä¸­çš„æ¨¡å‹ï¼‰
            if (currentRagModel === oldName) {
                currentRagModel = newName;
            }

            // åˆ·æ–°æ¨¡å‹åˆ—è¡¨
            loadRagModels();
            displayMessage('system', `Model renamed from "${oldName}" to "${newName}" successfully.`);
            
        } catch (error) {
            displayMessage('error', `Rename error: ${error.message}`);
        }
    }

    // åˆ é™¤ç°æœ‰æ¨¡å‹
    async function deleteExistingModel(modelName) {
        try {
            const response = await fetch(`${BASE_URL}/delete_rag_model`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model_name: modelName
                })
            });

            const result = await response.json();
            if (result.error) {
                displayMessage('error', `Delete failed: ${result.error}`);
                return;
            }

            // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰é€‰ä¸­çš„æ¨¡å‹ï¼Œé‡ç½®é€‰æ‹©
            if (currentRagModel === modelName) {
                currentRagModel = 'None';
                isRagEnabled = false;
                ragStatus.className = 'ml-1 inline-block w-3 h-3 rounded-full bg-gray-400';
                
                // å¯ç”¨æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½
                fileInputLabel?.classList.remove('opacity-50', 'pointer-events-none');
                chatFileInputLabel?.classList.remove('opacity-50', 'pointer-events-none');
                fileInput.disabled = false;
                chatFileInput.disabled = false;
            }

            // åˆ·æ–°æ¨¡å‹åˆ—è¡¨
            loadRagModels();
            displayMessage('system', `Model "${modelName}" deleted successfully.`);
            
        } catch (error) {
            displayMessage('error', `Delete error: ${error.message}`);
        }
    }

    // æ›´æ–°è®­ç»ƒè¿›åº¦ UI
// æ›´æ–°è®­ç»ƒè¿›åº¦ UI
function updateTrainingProgress(percentage, status, isError = false) {
    // æ›´æ–°æ¬¢è¿ç•Œé¢è¿›åº¦
    if (welcomeTrainingProgress) {
        welcomeTrainingProgress.classList.remove('hidden');
        welcomeTrainingProgressBar.style.width = `${percentage}%`;
        welcomeTrainingStatus.textContent = status;
        if (isError) {
            welcomeTrainingProgressBar.classList.add('bg-red-500');
        } else {
            welcomeTrainingProgressBar.classList.remove('bg-red-500');
        }
    }
    // æ›´æ–°èŠå¤©ç•Œé¢è¿›åº¦
    if (chatTrainingProgress) {
        chatTrainingProgress.classList.remove('hidden');
        chatTrainingProgressBar.style.width = `${percentage}%`;
        chatTrainingStatus.textContent = status;
        if (isError) {
            chatTrainingProgressBar.classList.add('bg-red-500');
        } else {
            chatTrainingProgressBar.classList.remove('bg-red-500');
        }
    }
    // æ›´æ–°æ¨¡æ€æ¡†è¿›åº¦
    if (modalTrainingProgress) {
        modalTrainingProgress.classList.remove('hidden');
        modalTrainingProgressBar.style.width = `${percentage}%`;
        modalTrainingStatus.textContent = status;
        if (isError) {
            modalTrainingProgressBar.classList.add('bg-red-500');
        } else {
            modalTrainingProgressBar.classList.remove('bg-red-500');
        }
    }
}

    // å¼€å§‹ RAG è®­ç»ƒ
async function startRagTraining() {
    if (isTraining) {
        displayMessage('error', 'A training process is already in progress.');
        return;
    }

    const files = modalFolderInput.files;
    if (files.length === 0) {
        displayMessage('error', 'Please select a folder with files.');
        return;
    }

    // ä»æ–‡ä»¶è·¯å¾„ä¸­æå–æ–‡ä»¶å¤¹åç§°ä½œä¸ºæ¨¡å‹åç§°
    const firstFile = files[0];
    const pathParts = firstFile.webkitRelativePath.split('/');
    const folderName = pathParts[0];
    const modelName = folderName.replace(/[^a-zA-Z0-9_-]/g, '_'); // æ¸…ç†åç§°

    isTraining = true;
    trainRagBtn.disabled = true;
    closeRagModelsModal();
    updateTrainingProgress(10, 'Uploading files...');

    try {
        const formData = new FormData();
        formData.append('folder_name', modelName); // å‘é€æ–‡ä»¶å¤¹åç§°è€Œä¸æ˜¯ç”¨æˆ·è¾“å…¥çš„åç§°
        for (const file of files) {
            formData.append('files[]', file, file.webkitRelativePath || file.name);
        }

        updateTrainingProgress(30, 'Processing files...');

        const response = await fetch(`${BASE_URL}/upload_folder_for_rag`, {
            method: 'POST',
            body: formData
        });

        updateTrainingProgress(80, 'Finalizing training...');

        const result = await response.json();
        if (result.error) {
            throw new Error(result.error);
        }

        updateTrainingProgress(100, 'Training complete!');

        setTimeout(() => {
            welcomeTrainingProgress?.classList.add('hidden');
            chatTrainingProgress?.classList.add('hidden');
            modalTrainingProgress?.classList.add('hidden');
            modalFolderInput.value = '';
            modalFolderInfo.textContent = '';
            trainRagBtn.disabled = true;
            
            // æ˜¾ç¤ºé‡å‘½åæˆåŠŸåŒºåŸŸè€Œä¸æ˜¯ç›´æ¥é€‰æ‹©æ¨¡å‹
            showRenameSuccessArea(result.model_name);
            
            displayMessage('system', `Successfully trained RAG model "${result.model_name}" with ${result.processed_files} files. You can rename it or use it directly.`);
            loadRagModels(); // åˆ·æ–°æ¨¡å‹åˆ—è¡¨
            isTraining = false;
            trainRagBtn.disabled = false;
        }, 1500);
    } catch (error) {
        console.error('RAG training error:', error);
        updateTrainingProgress(100, `Error: ${error.message || 'Failed to train model'}`, true);
        setTimeout(() => {
            mainTrainingProgress?.classList.add('hidden');
            chatTrainingProgress?.classList.add('hidden');
            modalTrainingProgress?.classList.add('hidden');
            mainTrainingProgressBar.classList.remove('bg-red-500');
            chatTrainingProgressBar.classList.remove('bg-red-500');
            modalTrainingProgressBar.classList.remove('bg-red-500');
            mainTrainingProgressBar.style.width = '0%';
            chatTrainingProgressBar.style.width = '0%';
            modalTrainingProgressBar.style.width = '0%';
            isTraining = false;
            trainRagBtn.disabled = false;
        }, 3000);
    }
}

    // åˆ›å»ºæ¶ˆæ¯å…ƒç´ ï¼ˆç”¨äºæµå¼å“åº”ï¼‰
    function createMessageElement(type, content) {
        const div = document.createElement('div');
        div.classList.add('chat-bubble', type === 'user' ? 'user-bubble' : type === 'ai' ? 'ai-bubble' : 'system-bubble');
        const header = document.createElement('div');
        header.className = 'flex items-center mb-1';
        const avatar = document.createElement('div');
        avatar.className = 'w-6 h-6 rounded-full flex items-center justify-center mr-2 text-white';
        avatar.style.backgroundColor = type === 'user' ? '#3b82f6' : type === 'ai' ? '#1e293b' : '#6b7280';
        const avatarText = document.createElement('span');
        avatarText.className = 'text-xs font-bold';
        avatarText.textContent = type === 'user' ? 'You' : type === 'ai' ? 'AI' : 'System';
        avatar.appendChild(avatarText);
        header.appendChild(avatar);
        div.appendChild(header);
        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        contentDiv.textContent = content;
        div.appendChild(contentDiv);
        return div;
    }

    // æ»šåŠ¨åˆ°åº•éƒ¨
    function scrollToBottom() {
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // æ˜¾ç¤ºæ¶ˆæ¯
    function displayMessage(type, content, isThinking = false) {
        if (isThinking) {
            const details = document.createElement('details');
            details.classList.add('chat-bubble', 'thinking-bubble');
            details.open = true;
            const summary = document.createElement('summary');
            summary.textContent = 'Thinking...';
            const contentDiv = document.createElement('div');
            contentDiv.textContent = content;
            contentDiv.style.paddingTop = '0.5rem';
            details.appendChild(summary);
            details.appendChild(contentDiv);
            chatContainer.appendChild(details);
        } else {
            const div = document.createElement('div');
            div.classList.add('chat-bubble', type === 'user' ? 'user-bubble' : type === 'ai' ? 'ai-bubble' : 'system-bubble');
            const header = document.createElement('div');
            header.className = 'flex items-center mb-1';
            const avatar = document.createElement('div');
            avatar.className = 'w-6 h-6 rounded-full flex items-center justify-center mr-2 text-white';
            avatar.style.backgroundColor = type === 'user' ? '#3b82f6' : type === 'ai' ? '#1e293b' : '#6b7280';
            const avatarText = document.createElement('span');
            avatarText.className = 'text-xs font-bold';
            avatarText.textContent = type === 'user' ? 'You' : type === 'ai' ? 'AI' : 'System';
            avatar.appendChild(avatarText);
            header.appendChild(avatar);
            div.appendChild(header);
            const contentDiv = document.createElement('div');
            contentDiv.textContent = content;
            div.appendChild(contentDiv);
            chatContainer.appendChild(div);
        }
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // ä¿å­˜æ¶ˆæ¯åˆ°æœ¬åœ°å­˜å‚¨
    function saveMessage(type, content, isThinking = false) {
        const history = JSON.parse(localStorage.getItem('chatHistory')) || [];
        history.push({ type, content, isThinking });
        localStorage.setItem('chatHistory', JSON.stringify(history));
    }

    // æ˜¾ç¤ºæ€è€ƒä¸­æ¶ˆæ¯
    function displayThinkingMessage(id) {
        const div = document.createElement('div');
        div.id = `thinking-${id}`;
        div.className = 'chat-bubble thinking-bubble';
        div.innerHTML = `
            <div class="flex items-center">
                <div class="w-2 h-2 bg-gray-400 rounded-full mr-1 animate-bounce"></div>
                <div class="w-2 h-2 bg-gray-400 rounded-full mr-1 animate-bounce" style="animation-delay: 0.2s"></div>
                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
                <div class="ml-2">AI is thinking...</div>
            </div>
        `;
        chatContainer.appendChild(div);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // ç§»é™¤æ€è€ƒä¸­æ¶ˆæ¯
    function removeThinkingMessage(id) {
        const thinkingMsg = document.getElementById(`thinking-${id}`);
        if (thinkingMsg) {
            thinkingMsg.remove();
        }
    }

    // æ˜¾ç¤ºèŠå¤©ç•Œé¢
    function showChatInterface() {
        welcomeScreen?.classList.add('fade-out');
        setTimeout(() => {
            welcomeScreen?.classList.add('hidden');
            chatInterface?.classList.remove('hidden');
            setTimeout(() => {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }, 100);
        }, 300);
    }

    // å¯ç”¨/ç¦ç”¨è¾“å…¥æ§ä»¶
    function setInputControlsDisabled(isDisabled, isChat) {
        if (isChat) {
            chatSendButton.disabled = isDisabled;
            chatQuestionInput.disabled = isDisabled;
            chatFileInput.disabled = isDisabled;
            const label = document.querySelector('label[for="chat-file-input"]');
            label?.classList.toggle('opacity-50', isDisabled);
            label?.classList.toggle('pointer-events-none', isDisabled);
            chatSendButton.innerHTML = isDisabled
                ? '<svg class="animate-spin -ml-1 mr-2 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Processing'
                : '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 1.414L10.586 9H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z" clip-rule="evenodd" /></svg>Send';
        } else {
            sendButton.disabled = isDisabled;
            questionInput.disabled = isDisabled;
            fileInput.disabled = isDisabled;
            const label = document.querySelector('label[for="file-input"]');
            label?.classList.toggle('opacity-50', isDisabled);
            label?.classList.toggle('pointer-events-none', isDisabled);
            sendButton.innerHTML = isDisabled
                ? '<svg class="animate-spin -ml-1 mr-2 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Processing'
                : '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 1.414L10.586 9H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z" clip-rule="evenodd" /></svg>';
        }
    }

    // æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€
    async function checkServerStatus() {
        try {
            const response = await fetch(`${BASE_URL}/health`);
            if (!response.ok) {
                displayServerError();
                return;
            }
            const data = await response.json();
            if (data.rag_available) {
                loadRagModels();
            }
            // æµ‹è¯• LLM è¿æ¥
            const llmResponse = await fetch(`${BASE_URL}/test_llm`);
            if (!llmResponse.ok) {
                displayLLMError();
            }
        } catch (error) {
            console.error('Failed to connect to server:', error);
            displayServerError();
        }
    }

    // æ˜¾ç¤ºæœåŠ¡å™¨é”™è¯¯
    function displayServerError() {
        const errorMsg = document.createElement('div');
        errorMsg.className = 'p-4 mb-4 text-sm text-white bg-red-500 rounded-lg';
        errorMsg.textContent = 'Failed to connect to server. Please make sure the Flask server is running.';
        document.querySelector('.welcome-container')?.prepend(errorMsg);
    }

    // æ˜¾ç¤º LLM é”™è¯¯
    function displayLLMError() {
        const errorMsg = document.createElement('div');
        errorMsg.className = 'p-4 mb-4 text-sm text-white bg-orange-500 rounded-lg';
        errorMsg.textContent = 'Server is running but cannot connect to LLM. Please make sure LM Studio is running.';
        document.querySelector('.welcome-container')?.prepend(errorMsg);
    }

    // åˆ›å»ºè¤ç«è™«æ•ˆæœ
    function createFireflies() {
        const darkBg = document.getElementById('dark-bg');
        const fireflyCount = 30; 

        for (let i = 0; i < fireflyCount; i++) {
            const firefly = document.createElement('div');
            firefly.className = 'firefly';
        
            // éšæœºä½ç½®
            const left = Math.random() * 100;
            const top = Math.random() * 100;
            firefly.style.left = `${left}%`;
            firefly.style.top = `${top}%`;
        
            // éšæœºåŠ¨ç”»æ—¶é•¿ï¼ˆ50s åˆ° 150sï¼‰
            const duration = 50 + Math.random() * 100;
            firefly.style.animationDuration = `${duration}s`;
        
            // éšæœºåŠ¨ç”»å»¶è¿Ÿï¼ˆ0s åˆ° 10sï¼‰
            const delay = Math.random() * 10;
            firefly.style.animationDelay = `${delay}s`;
        
            // éšæœºåˆå§‹æ—‹è½¬è§’åº¦
            firefly.style.transform = `rotate(${Math.random() * 360}deg)`;
        
            darkBg.appendChild(firefly);
        }
    }

    // åˆå§‹åŒ– UI
    function initUI() {
        if (isDarkMode) {
            toggleTheme();
        }
        // åŠ è½½èŠå¤©å†å²
        const history = JSON.parse(localStorage.getItem('chatHistory')) || [];
        if (history.length > 0) {
            showChatInterface();
            history.forEach(msg => displayMessage(msg.type, msg.content, msg.isThinking));
        }

        // æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€
        checkServerStatus();
    }

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
        initializeEventListeners();
        initUI();
    });
</script>
</body>
</html>
